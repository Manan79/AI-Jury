{% extends "layout.html" %}
{% block title %}AI Jury â€” Chat{% endblock %}
{% block content %}

<div class="h-auto mx w-full">
    <div class="grid grid-cols-12 gap-0 h-full">
        <!-- Sidebar -->
        <aside class="col-span-12 md:col-span-3 xl:col-span-2 border-r border-zinc-200 bg-gradient-to-tr from-indigo-200 via-indigo-100 to-transparent opacity-70 dark:from-indigo-900/40 dark:via-indigo-800/30 dark:to-transparent backdrop-blur-sm h-[500px] ">
            <div class="flex h-full flex-col">
                <!-- Sidebar header -->
                <div class="px-4 py-4 border-b border-zinc-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-sm font-semibold dark:text-white text-black">Chats</h2>
                        <button class="inline-flex items-center rounded-md bg-indigo-600 px-2.5 py-1.5 text-xs font-semibold text-white shadow-sm ring-1 ring-inset ring-indigo-500/40 hover:bg-indigo-700 transition" onclick="handleNewChat()">New</button>

                    </div>
                    <div class="mt-3">
                        <div class="relative">
                            <input type="text" id="search-chats" placeholder="Search chats" class="w-full rounded-md border border-zinc-200 bg-white px-3 py-1.5 text-sm dark:text-white text-black placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                            <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-zinc-400">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat list -->
                <div id="chat-list" class="flex-1 overflow-y-auto divide-y divide-zinc-100">
                    <!-- Chat items will be loaded here -->
                </div>

                <!-- Sidebar footer -->
                <div class="px-4 py-4 border-t border-zinc-200">
                    <a href="#" class="inline-flex items-center gap-2 text-xs dark:text-white  text-black">
                        <span class="inline-flex h-5 w-5 items-center justify-center rounded bg-indigo-600 text-white ring-1 ring-indigo-500/40">AI</span>
                        AI Jury Chat
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main chat area -->
        <section class="col-span-12 md:col-span-9 xl:col-span-10 h-full">
            <div class="flex h-full flex-col">
                <!-- Conversation header -->
                <div class="sticky top-0 z-10 border-b border-zinc-200 bg-indigo-800/30 backdrop-blur px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-indigo-600 text-white ring-1 ring-indigo-500/40">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v3m0 12v3m0-15a9 9 0 0 1 9 9m-9-9a9 9 0 0 0-9 9"/></svg>
                            </div>
                            <h3 id="chat-title" class="text-sm font-semibold  dark:text-white text-black">New chat</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="clearChat()" class="rounded-md px-2.5 py-1.5 text-xs font-medium text-zinc-600 dark:text-white ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50">Clear</button>
                            <button onclick="exportChat()" class="rounded-md px-2.5 py-1.5 text-xs font-medium text-zinc-600 dark:text-white ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50">Export</button>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages" class="flex-1 overflow-y-auto px-4 dark:text-white text-black sm:px-6 lg:px-8 py-6 space-y-6">
                    <!-- Messages will render here -->
                </div>

                <!-- Composer -->
                <div class="  px-4 sm:px-6 lg:px-8 py-4 mx-4 rounded-xl">
                    <form class="mx-auto max-w-3xl" onsubmit="sendMessage(event)">
                        <div class="flex items-end gap-3">
                            <div class="flex-1">
                            <div class="relative">
                                    <textarea id="chat-input" rows="1" placeholder="Message AI Jury about your legal case..." class="w-full resize-none rounded-xl border border-indigo-900  dark:border-zinc-200 bg-white px-4 py-3 pr-12 text-sm font-medium dark:text-white text-black placeholder-zinc-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-200" oninput="autoResize(this)"></textarea>
                                <div class="absolute bottom-3 right-3 flex items-center gap-2">
                                    <input type="file" id="file-input" accept="image/*,application/pdf" multiple class="hidden" onchange="handleFileSelect(this.files)" />
                                    <button type="button" title="Attach file" onclick="document.getElementById('file-input').click()" class="rounded-md px-2.5 py-1.5 text-xs font-medium text-zinc-600 ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12v5a5 5 0 0 1-10 0V7a3 3 0 1 1 6 0v9a1 1 0 0 1-2 0V8"/></svg>
                                    </button>
                                </div>
                                </div>
                            </div>
                            <button type="submit" id="send-button" class="inline-flex items-center rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-indigo-500/40 hover:bg-indigo-700 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="mr-2 h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M12 5l7 7-7 7"/></svg>
                                Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
let currentSessionId = null;
let isProcessing = false;
let hasUserSentMessage = false; // Track if user actually sent something

// Utility functions (keep these the same)
function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

// SMARTER: Chat session management
async function createNewChat(showWelcome = true) {
    try {
        // Reset the message tracker
        hasUserSentMessage = false;
        
        const response = await fetch('/api/chat/sessions/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        currentSessionId = data.session_id;
        
        // SMARTER: Only update title if we have a real one
        if (data.title && data.title !== 'New chat') {
            document.getElementById('chat-title').textContent = data.title;
        } else {
            document.getElementById('chat-title').textContent = 'New chat';
        }
        
        document.getElementById('messages').innerHTML = '';
        
        // SMARTER: Only show welcome if requested
        if (showWelcome) {
            addWelcomeMessage();
        }
        
        // SMARTER: Don't immediately load sessions (avoids showing empty chats)
        // We'll load sessions after user sends first message
        
        // SMARTER: Save to localStorage
        saveCurrentSession();
        
    } catch (error) {
        console.error('Error creating new chat:', error);
        alert('Error creating new chat. Please check if the API server is running.');
    }
}

// SMARTER: Load chat sessions with empty chat filtering
async function loadChatSessions() {
    try {
        const response = await fetch('/api/chat/sessions/');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const chatList = document.getElementById('chat-list');
        
        chatList.innerHTML = '';
        
        if (data.sessions && data.sessions.length > 0) {
            // SMARTER: Filter out empty or useless chats
            const meaningfulSessions = data.sessions.filter(session => {
                // Don't show sessions with no messages or only system messages
                return (session.message_count || 0) > 0 && 
                       session.title !== 'New chat' &&
                       session.title !== 'Untitled chat';
            });
            
            if (meaningfulSessions.length > 0) {
                meaningfulSessions.forEach(session => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left px-4 py-3 hover:bg-zinc-50 focus:bg-zinc-50 transition-colors duration-200';
                    button.innerHTML = `
                        <p class="text-sm font-medium dark:text-white text-black truncate">${session.title || 'Untitled chat'}</p>
                        <p class="text-xs text-zinc-500 truncate">${formatTimeAgo(session.last_activity || session.created_at)} â€¢ ${session.message_count || 0} messages</p>
                    `;
                    button.onclick = () => loadChatSession(session.id);
                    chatList.appendChild(button);
                });
            } else {
                chatList.innerHTML = '<p class="px-4 py-3 text-sm text-zinc-500">No chats yet</p>';
            }
        } else {
            chatList.innerHTML = '<p class="px-4 py-3 text-sm text-zinc-500">No chats yet</p>';
        }
    } catch (error) {
        console.error('Error loading chat sessions:', error);
        document.getElementById('chat-list').innerHTML = '<p class="px-4 py-3 text-sm text-zinc-500">Error loading chats</p>';
    }
}

// SMARTER: Load specific chat session
async function loadChatSession(sessionId) {
    try {
        const response = await fetch(`/api/chat/sessions/${sessionId}/messages/`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        currentSessionId = sessionId;
        hasUserSentMessage = true; // We're loading an existing chat with messages
        
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';
        
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(message => {
                addMessageToChat(message.content, message.is_user, message.timestamp, message.thinking_time);
            });
            // SMARTER: Update title based on actual content
            updateChatTitleFromMessages(data.messages);
        } else {
            // This shouldn't happen with our filtering, but just in case
            addWelcomeMessage();
        }
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // SMARTER: Save to localStorage
        saveCurrentSession();
        
        // Refresh session list
        loadChatSessions();
        
    } catch (error) {
        console.error('Error loading chat session:', error);
        alert('Error loading chat session.');
    }
}

// SMARTER: Generate better chat titles from message content
function updateChatTitleFromMessages(messages) {
    const userMessages = messages.filter(msg => msg.is_user);
    if (userMessages.length > 0) {
        const firstUserMessage = userMessages[0].content;
        // Create a smart title from first message
        let title = firstUserMessage.substring(0, 50); // First 50 chars
        if (firstUserMessage.length > 50) {
            title += '...';
        }
        document.getElementById('chat-title').textContent = title;
    }
}

function addWelcomeMessage() {
    const messagesContainer = document.getElementById('messages');
    const welcomeMsg = document.createElement('div');
    welcomeMsg.className = 'flex items-start gap-3';
    welcomeMsg.innerHTML = `
        <div class="mt-0.5 inline-flex h-8 w-8 items-center justify-center rounded-md bg-indigo-600 text-white ring-1 ring-indigo-500/40">AI</div>
        <div class="flex-1">
            <div class="rounded-xl ring-1 ring-zinc-200 bg-white px-4 py-4 shadow-sm">
                <div class="prose prose-zinc max-w-none text-sm dark:text-white text-black">
                    <p>Hello! I'm your AI Jury assistant. I can help you analyze legal cases, find relevant precedents from Supreme Court verdicts, and provide judicial insights. How can I assist you today?</p>
                </div>
            </div>
        </div>
    `;
    messagesContainer.appendChild(welcomeMsg);
}

// SMARTER: Message handling
async function sendMessage(e) {
    e.preventDefault();
    
    if (isProcessing) return;
    
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // SMARTER: Track that user has actually sent a message
    hasUserSentMessage = true;
    
    // If no session exists, create one first
    if (!currentSessionId) {
        await createNewChat(false); // Don't show welcome - we're about to add real messages
        if (!currentSessionId) {
            alert('Failed to create chat session');
            return;
        }
    }
    
    isProcessing = true;
    
    // Disable input while sending
    input.disabled = true;
    document.getElementById('send-button').disabled = true;
    
    // Add user message to chat immediately
    addMessageToChat(message, true);
    input.value = '';
    autoResize(input);
    
    try {
        // Build multipart form data to support attachments
        const formData = new FormData();
        formData.append('message', message);
        formData.append('session_id', currentSessionId);
        if (window.__selectedFiles && window.__selectedFiles.length > 0) {
            for (const file of window.__selectedFiles) {
                formData.append('attachments', file);
            }
        }

        const response = await fetch('/api/chat/send/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
            body: formData,
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update session ID if a new one was created
        if (data.session_id) {
            currentSessionId = data.session_id;
        }
        
        // SMARTER: Update chat title based on the first user message
        if (data.title && data.title !== 'New chat') {
            document.getElementById('chat-title').textContent = data.title;
        }
        
        // Add AI response to chat
        if (data.ai_message) {
            addMessageToChat(
                data.ai_message.content, 
                false, 
                data.ai_message.timestamp, 
                data.ai_message.thinking_time
            );
        } else if (data.response) {
            addMessageToChat(
                data.response, 
                false, 
                new Date().toISOString()
            );
        }
        
        // SMARTER: Only update sessions after real conversation happens
        loadChatSessions();
        
        // SMARTER: Save current session
        saveCurrentSession();
        
    } catch (error) {
        console.error('Error sending message:', error);
        addMessageToChat(
            "Sorry, I encountered an error while processing your request. Please check if the RAG API server is running and try again.", 
            false
        );
    } finally {
        // Re-enable input
        input.disabled = false;
        document.getElementById('send-button').disabled = false;
        input.focus();
        isProcessing = false;
    }
}

// SMARTER: Save current session to localStorage
function saveCurrentSession() {
    if (currentSessionId) {
        localStorage.setItem('lastChatSession', currentSessionId);
    }
}

// SMARTER: Load last session from localStorage
async function loadLastSession() {
    const lastSessionId = localStorage.getItem('lastChatSession');
    if (lastSessionId) {
        // Verify the session still exists and has messages
        try {
            const response = await fetch(`/api/chat/sessions/${lastSessionId}/messages/`);
            if (response.ok) {
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    await loadChatSession(lastSessionId);
                    return true; // Successfully loaded last session
                }
            }
        } catch (error) {
            console.log('Last session no longer available');
        }
    }
    return false; // No valid last session
}

// SMARTER: Improved New Chat button handler
async function handleNewChat() {
    // Only create new chat if we're not already in an empty one
    if (!currentSessionId || hasUserSentMessage) {
        await createNewChat(true);
    } else {
        // We're already in a new empty chat, just clear and show welcome
        document.getElementById('messages').innerHTML = '';
        addWelcomeMessage();
        document.getElementById('chat-title').textContent = 'New chat';
        hasUserSentMessage = false;
    }
}

// Update the New Chat button in your HTML:
// Change: onclick="createNewChat()" to onclick="handleNewChat()"

function addMessageToChat(content, isUser, timestamp = null, thinkingTime = null) {
    const messages = document.getElementById('messages');
    const wrapper = document.createElement('div');
    wrapper.className = 'flex items-start gap-3';
    
    const now = new Date();
    const timeString = timestamp ? formatTimeAgo(timestamp) : now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    if (isUser) {
        wrapper.innerHTML = `
            <div class="mt-0.5 inline-flex h-8 w-8 items-center justify-center rounded-md bg-zinc-200 text-zinc-700 ring-1 ring-zinc-300">U</div>
            <div class="flex-1">
                <div class="rounded-xl ring-1 ring-zinc-200 bg-white px-4 py-3 shadow-sm">
                    <p class="text-sm dark:text-white text-black">${content}</p>
                </div>
                <div class="mt-2 text-[11px] text-zinc-500">you â€¢ ${timeString}</div>
            </div>
        `;
    } else {
        const thinkingTimeHtml = thinkingTime ? `
            <span class="inline-flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-3.5 w-3.5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l4 2"/></svg>
                thinking time: ${thinkingTime}s
            </span>
        ` : '';
        
        wrapper.innerHTML = `
            <div class="mt-0.5 inline-flex h-8 w-8 items-center justify-center rounded-md bg-indigo-600 text-white ring-1 ring-indigo-500/40">AI</div>
            <div class="flex-1">
                <div class="rounded-xl ring-1 ring-zinc-200 bg-white px-4 py-4 shadow-sm">
                    <div class="prose prose-zinc max-w-none text-sm dark:text-white text-black">
                        ${content}
                    </div>
                </div>
                <div class="mt-2 flex items-center gap-3 text-[11px] text-zinc-500">
                    <span>AI Jury â€¢ ${timeString}</span>
                    ${thinkingTimeHtml}
                </div>
            </div>
        `;
    }
    
    messages.appendChild(wrapper);
    messages.scrollTop = messages.scrollHeight;
}

// Utility function to get CSRF token
function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// SMARTER: Clear chat function
function clearChat() {
    if (confirm('Are you sure you want to clear this chat?')) {
        document.getElementById('messages').innerHTML = '';
        addWelcomeMessage();
        hasUserSentMessage = false;
        document.getElementById('chat-title').textContent = 'New chat';
    }
}

function exportChat() {
    alert('Export feature coming soon!');
}

// SMARTER: Initialize when page loads
document.addEventListener('DOMContentLoaded', async function() {
    // Try to load the last session first
    const loadedLastSession = await loadLastSession();
    
    if (!loadedLastSession) {
        // No valid last session, start fresh but don't create empty chat
        loadChatSessions();
        addWelcomeMessage();
        document.getElementById('chat-title').textContent = 'New chat';
    }
    
    // Focus on input field
    document.getElementById('chat-input').focus();
});

// Add search functionality (keep this the same)
document.getElementById('search-chats').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const chatItems = document.querySelectorAll('#chat-list button');
    
    chatItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Handle file selection and show small badges near the send button
window.__selectedFiles = [];
function handleFileSelect(fileList) {
    const files = Array.from(fileList || []);
    if (files.length === 0) return;
    // Only allow images and PDFs
    const accepted = files.filter(f => (f.type && (f.type.startsWith('image/') || f.type === 'application/pdf')));
    window.__selectedFiles = accepted;
}
</script>

{% endblock %}